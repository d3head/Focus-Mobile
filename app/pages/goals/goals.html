<ion-header>
  <ion-navbar light>
    <button menuToggle>
      <ion-icon name="menu"></ion-icon>
    </button>
    <ion-title>Отчет</ion-title>

    <ion-buttons end>
      <button (click)="showPopover($event)">
        <ion-icon name="more"></ion-icon>
      </button>
    </ion-buttons>
  </ion-navbar>
</ion-header>

<button orange class="add-task-btn" fab (click)="addTaskScreen()">
  <ion-icon name="add"></ion-icon>
</button>

<ion-content id="goals-content">
  <ion-list *ngIf="targets" class="list">
    <ion-item tappable (click)="expandGoal(0)" class="heading">
      <ion-icon *ngIf="targets.reply.reply.day_conclusion && targets.reply.reply.description" name="checkmark-circle" green class="target-complete"></ion-icon>
      Вывод дня
      <ion-badge [style.background-color]="dayStatus.color" style="color:#000;font-weight: 400;">{{dayStatus.text}}</ion-badge>

      <ion-icon item-right name="arrow-down" *ngIf="!expandedGoal[0].visible"></ion-icon>
      <ion-icon item-right name="arrow-up" *ngIf="expandedGoal[0].visible"></ion-icon>
    </ion-item>

    <div class="expandedGoal day {{expandedGoal[0].visible ? 'active': ''}}">
      <ion-item>
        <ion-label stacked>Главный вывод дня</ion-label>
        <ion-input type="text" [(ngModel)]="targets.reply.reply.day_conclusion" (ngModelChange)="calcProgress()"></ion-input>
      </ion-item>

      <ion-item>
        <ion-label stacked>Подробнее</ion-label>
        <ion-textarea [(ngModel)]="targets.reply.reply.description" (ngModelChange)="calcProgress()"></ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label>Продуктивно</ion-label>
        <ion-checkbox primary [(ngModel)]="targets.reply.reply.work" (ngModelChange)="updateDayStatus()"></ion-checkbox>
      </ion-item>

      <ion-item>
        <ion-label>Отдохнул</ion-label>
        <ion-checkbox yellow [(ngModel)]="targets.reply.reply.relax" (ngModelChange)="updateDayStatus()"></ion-checkbox>
      </ion-item>

      <ion-item no-border>
        <div *ngIf="photos[0]">
          <ion-scroll scrollX="true" *ngIf="photos[0].length > 0">
            <div class="photos">
              <img *ngFor="let img of photos[0];let $index = index; trackBy:$index" src="http://api.gofocus.ru/img/170/{{img}}" tappable (click)="photosAction(0, $index)"/>
            </div>
          </ion-scroll>
        </div>
        <button dark outline (click)="attachImages(0)"><ion-icon name="attach"></ion-icon>Прикрепить фотографию</button>
      </ion-item>
    </div>

    <div *ngIf="targets">
      <div *ngFor="let item of targets.target_reports.target_reports; let $index = index">
        <ion-item tappable (click)="expandGoal($index+1)" class="heading">
          <ion-icon *ngIf="item.comment" name="checkmark-circle" green class="target-complete"></ion-icon>
          {{item.target.name}}

          <ion-icon item-right name="arrow-down" *ngIf="!expandedGoal[$index+1].visible"></ion-icon>
          <ion-icon item-right name="arrow-up" *ngIf="expandedGoal[$index+1].visible"></ion-icon>
        </ion-item>

        <div class="expandedGoal {{expandedGoal[$index+1].visible ? 'active': ''}}">
          <ion-item>
            <ion-label stacked>Подробнее</ion-label>
            <ion-textarea [(ngModel)]="item.comment" (ngModelChange)="calcProgress()"></ion-textarea>
          </ion-item>

          <ion-item no-border>
            <div *ngIf="photos[parseInt($index)+1]">
              <ion-scroll scrollX="true" *ngIf="photos[parseInt($index)+1].length > 0">
                <div class="photos">
                  <img *ngFor="let img of photos[parseInt($index)+1];let $iindex = index; trackBy:$iindex" src="http://api.gofocus.ru/img/170/{{img}}" tappable (click)="photosAction(parseInt($index)+1, $iindex)"/>
                </div>
              </ion-scroll>
            </div>
            <button dark outline (click)="attachImages(parseInt($index)+1)"><ion-icon name="attach"></ion-icon>Прикрепить фотографию</button>
          </ion-item>
        </div>
      </div>
    </div>
  </ion-list>

  <div padding *ngIf="progress <= 90">
    Чтобы отправить отчет, необходимо заполнить все поля.
  </div>

  <div class="report-btns" padding>
    <button primary outline (click)="saveReport()">Сохранить</button>

    <button primary (click)="publishReport()" [disabled]="disableSend">Опубликовать</button>
  </div>
</ion-content>

<ion-grid class="progress-bar goals-bar fixed">
  <ion-row>
    <ion-col width-30>Отчет заполнен на {{progress}}%</ion-col>
  </ion-row>

  <ion-row>
    <ion-col><div class="progress"><div class="bar" [ngStyle]="{'width': progress + '%'}"></div></div></ion-col>
  </ion-row>
</ion-grid>
